<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameGram Lobby Chat</title>
  <style>
    :root {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      --bg: #36393f;
      --panel: #2f3136;
      --accent: #5865f2;
      --text: #dcddde;
      --muted: #72767d;
    }
    body { margin:0; background:var(--bg); color:var(--text); display:flex; justify-content:center; }
    .chat { display:flex; flex-direction:column; height:100vh; width:100%; max-width:800px; }
    header { background:var(--panel); padding:12px; font-weight:bold; text-align:center; }
    #messages { flex:1; overflow-y:auto; padding:12px; }
    .msg { margin-bottom:10px; }
    .msg .meta { font-size:12px; color:var(--muted); margin-bottom:2px; }
    .msg .text { font-size:14px; line-height:1.4; }
    .msg .nickname { font-weight:600; margin-right:6px; }
    .system { text-align:center; font-size:12px; color:var(--muted); margin:8px 0; }
    footer { background:var(--panel); padding:12px; display:flex; gap:8px; }
    input { flex:1; padding:8px; border:none; border-radius:4px; background:#40444b; color:var(--text); }
    button { padding:8px 12px; border:none; border-radius:4px; background:var(--accent); color:white; cursor:pointer; }
    button:hover { background:#4752c4; }
  </style>
</head>
<body>
  <div class="chat">
    <header>GameGram Lobby Chat</header>
    <div id="messages"></div>
    <footer>
      <input id="input" placeholder="Type a message..." />
      <button id="send">Send</button>
    </footer>
  </div>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script>
    const messagesEl=document.getElementById('messages');
    const input=document.getElementById('input');
    const sendBtn=document.getElementById('send');

    let nickname=prompt("Enter your nickname:") || "Guest"+Math.floor(Math.random()*1000);

    // One fixed host ID for everyone
    const hostId="public-lobby-host";
    let role, peer, conn;
    const conns=new Set();

    startAsRandomPeerAndTryConnectToHost();

    function startAsRandomPeerAndTryConnectToHost(){
      role=null;
      peer=new Peer();
      peer.on('open',id=>{
        addSystem(`Connected as ${nickname}`);
        tryConnectToHost();
      });
      peer.on('connection', incoming=>{
        incoming.on('open',()=>{
          incoming.send({type:'system',text:'Spectator connected'});
        });
      });
    }

    function tryConnectToHost(){
      let connected=false;
      const attempt=peer.connect(hostId,{reliable:true});
      attempt.on('open',()=>{
        connected=true;
        role='client';
        conn=attempt;
        setupConn(conn);
        sendJoin();
      });
      setTimeout(()=>{ if(!connected){
        try{attempt.close();}catch(e){}
        try{peer.destroy();}catch(e){}
        startAsHost();
      }},2500);
    }

    function startAsHost(){
      role='host';
      peer=new Peer(hostId);
      peer.on('open',()=>{
        addSystem(`Hosting public lobby as ${nickname}`);
        sendJoin();
      });
      peer.on('connection',c=>{
        conns.add(c);
        setupConn(c);
        addSystem('A user joined');
        broadcast({type:'system',text:`${timestamp()} – A user joined`});
      });
    }

    function setupConn(c){
      c.on('data',d=>{
        if(d.type==='chat'){
          addMsg(d.nickname,d.text,d.time);
          if(role==='host') broadcast(d,c);
        } else if(d.type==='system'){
          addSystem(d.text);
        } else if(d.type==='join'){
          addSystem(`${d.time} – ${d.nickname} joined`);
          if(role==='host') broadcast(d,c);
        }
      });
      c.on('close',()=>{conns.delete(c); addSystem(`${timestamp()} – A user left`); if(role==='host') broadcast({type:'system',text:`${timestamp()} – A user left`}); });
      c.on('error',err=>{conns.delete(c); console.warn(err);});
    }

    function broadcast(data,except){
      conns.forEach(c=>{if(c!==except && c.open) c.send(data);});
    }

    function sendMsg(){
      const text=input.value.trim();
      if(!text)return;
      input.value='';
      const data={type:'chat',nickname,text,time:timestamp()};
      addMsg(nickname,text,data.time);
      if(role==='host') broadcast(data);
      else if(conn&&conn.open) conn.send(data);
    }

    function sendJoin(){
      const data={type:'join',nickname,time:timestamp()};
      if(role==='host') broadcast(data);
      else if(conn&&conn.open) conn.send(data);
    }

    sendBtn.onclick=sendMsg;
    input.addEventListener('keypress',e=>{if(e.key==='Enter')sendMsg();});

    function addMsg(nick,text,time){
      const div=document.createElement('div');
      div.className='msg';
      div.innerHTML=`<div class="meta"><span class="nickname">${nick}</span> <span>${time}</span></div><div class="text">${escapeHtml(text)}</div>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }

    function addSystem(text){
      const div=document.createElement('div');
      div.className='system';
      div.textContent=text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }

    function timestamp(){
      const d=new Date();
      return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }

    function escapeHtml(s){
      return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
    }
  </script>
</body>
</html>

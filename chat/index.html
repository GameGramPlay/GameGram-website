<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lobby Chat</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Login overlay -->
  <div id="login">
    <div class="box">
      <h1>Enter Lobby</h1>
      <input id="nickInput" placeholder="Nickname" />
      <button id="loginBtn">Join</button>
    </div>
  </div>

  <!-- App -->
  <div class="sidebar">
    <h2>Online</h2>
    <div id="userList"></div>
    <div class="settings">
      <label>Nickname Color
        <input type="color" id="nickColor" value="#ffffff" />
      </label>
      <label>Status
        <select id="statusSelect">
          <option value="online" selected>Online</option>
          <option value="idle">Idle</option>
          <option value="dnd">Do Not Disturb</option>
        </select>
      </label>
      <label>Font Size
        <input type="range" id="fontSize" min="12" max="20" value="14" />
      </label>
      <label>Theme
        <select id="themeSelect">
          <option value="dark" selected>Dark</option>
          <option value="light">Light</option>
          <option value="amoled">AMOLED</option>
        </select>
      </label>
      <label>Message Style
        <select id="msgStyle">
          <option value="cozy" selected>Cozy</option>
          <option value="compact">Compact</option>
        </select>
      </label>
    </div>
  </div>

  <div class="chat">
    <header>Public Lobby Chat</header>
    <div id="messages"></div>
    <div id="typing"></div>
    <footer>
      <input id="input" type="text" placeholder="Type a message..." />
      <button id="send">Send</button>
    </footer>
  </div>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script>
    const messagesEl=document.getElementById('messages');
    const input=document.getElementById('input');
    const sendBtn=document.getElementById('send');
    const userListEl=document.getElementById('userList');
    const login=document.getElementById('login');
    const nickInput=document.getElementById('nickInput');
    const loginBtn=document.getElementById('loginBtn');
    const nickColorInput=document.getElementById('nickColor');
    const typingEl=document.getElementById('typing');

    let nickname="";
    let nickColor="#ffffff";
    let status="online";

    const hostId="public-lobby-host";
    let role, peer, conn;
    const conns=new Set();
    let users={}; 
    let chatHistory=[]; 

    // Login
    loginBtn.onclick=()=>{
      nickname=nickInput.value.trim()||"Guest"+Math.floor(Math.random()*1000);
      login.style.display='none';
      startAsRandomPeerAndTryConnectToHost();
    };

    // Settings
    nickColorInput.oninput=()=>{nickColor=nickColorInput.value;};
    document.getElementById('statusSelect').onchange=e=>{status=e.target.value; sendJoin();};
    document.getElementById('fontSize').oninput=e=>{messagesEl.style.fontSize=e.target.value+"px";};
    document.getElementById('themeSelect').onchange=e=>applyTheme(e.target.value);
    document.getElementById('msgStyle').onchange=e=>applyMsgStyle(e.target.value);

    // Networking
    function startAsRandomPeerAndTryConnectToHost(){
      role=null;
      peer=new Peer();
      peer.on('open',id=>{
        addSystem(`Connected as ${nickname}`);
        tryConnectToHost();
      });
      peer.on('connection', incoming=>{
        incoming.on('open',()=>{ incoming.send({type:'system',text:'Spectator connected'}); });
      });
    }

    function tryConnectToHost(){
      let connected=false;
      const attempt=peer.connect(hostId,{reliable:true});
      attempt.on('open',()=>{
        connected=true;
        role='client';
        conn=attempt;
        setupConn(conn);
        sendJoin();
      });
      setTimeout(()=>{ if(!connected){ try{attempt.close();}catch(e){} try{peer.destroy();}catch(e){} startAsHost(); }},2500);
    }

    function startAsHost(){
      role='host';
      peer=new Peer(hostId);
      peer.on('open',()=>{ addSystem(`Hosting public lobby as ${nickname}`); sendJoin(); });
      peer.on('connection',c=>{
        conns.add(c);
        setupConn(c);
        addSystem('A user joined');
        broadcast({type:'system',text:`${timestamp()} â€“ A user joined`});
        // send user list + chat history
        c.send({type:'userlist',users});
        c.send({type:'history',history:chatHistory});
      });
    }

    function setupConn(c){
      c.on('data',d=>{
        if(d.type==='chat'){
          addMsg(d.nickname,d.text,d.time,d.color,d.id);
          if(role==='host') broadcast(d,c);
        } else if(d.type==='system'){
          addSystem(d.text);
        } else if(d.type==='join'){
          users[c.peer]={nick:d.nickname,color:d.color,status:d.status};
          updateUserList();
          addSystem(`${d.time} â€“ ${d.nickname} joined`);
          if(role==='host') broadcast(d,c);
        } else if(d.type==='userlist'){
          users=d.users; updateUserList();
        } else if(d.type==='history'){
          d.history.forEach(m=>addMsg(m.nick,m.text,m.time,m.color,m.id));
        } else if(d.type==='typing'){
          showTyping(d.nickname);
        } else if(d.type==='edit'){
          const msgEl=messagesEl.querySelector(`.msg[data-id="${d.id}"] .text`);
          if(msgEl) msgEl.textContent=d.newText;
          updateHistory(d.id,d.newText);
        } else if(d.type==='delete'){
          const msgEl=messagesEl.querySelector(`.msg[data-id="${d.id}"]`);
          if(msgEl) msgEl.remove();
          chatHistory=chatHistory.filter(m=>m.id!==d.id);
        }
      });
      c.on('close',()=>{conns.delete(c); delete users[c.peer]; updateUserList(); addSystem(`${timestamp()} â€“ A user left`); if(role==='host') broadcast({type:'system',text:`${timestamp()} â€“ A user left`}); });
      c.on('error',err=>{conns.delete(c); delete users[c.peer]; updateUserList(); console.warn(err);});
    }

    function broadcast(data,except){ conns.forEach(c=>{if(c!==except && c.open)c.send(data);}); }

    function sendMsg(){
      const text=input.value.trim(); if(!text)return; input.value='';
      const data={type:'chat',nickname,text,time:timestamp(),color:nickColor,id:Date.now()};
      addMsg(nickname,text,data.time,nickColor,data.id);
      if(role==='host') broadcast(data); else if(conn&&conn.open) conn.send(data);
    }

    function sendJoin(){
      const data={type:'join',nickname,color:nickColor,status,time:timestamp()};
      if(role==='host'){ users[peer.id]={nick:nickname,color:nickColor,status}; updateUserList(); broadcast(data);} 
      else if(conn&&conn.open) conn.send(data);
    }

    sendBtn.onclick=sendMsg;
    input.addEventListener('keypress',e=>{if(e.key==='Enter')sendMsg();});
    input.addEventListener('input',()=>{ 
      const data={type:'typing',nickname};
      if(role==='host') broadcast(data); else if(conn&&conn.open) conn.send(data);
    });

    function addMsg(nick,text,time,color,id){
      const div=document.createElement('div');
      div.className='msg';
      div.dataset.id=id;
      div.innerHTML=`<div class="meta"><span class="nickname" style="color:${color}">${nick}</span> <span>${time}</span> ${nick===nickname?`<button class="editBtn">âœŽ</button><button class="delBtn">ðŸ—‘</button>`:""}</div><div class="text">${escapeHtml(text)}</div>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
      chatHistory.push({id,nick,text,time,color});
      div.querySelectorAll('.editBtn').forEach(btn=>{btn.onclick=()=>editMsg(div,id);});
      div.querySelectorAll('.delBtn').forEach(btn=>{btn.onclick=()=>deleteMsg(div,id);});
    }
    function editMsg(div,id){
      const newText=prompt("Edit message:",div.querySelector('.text').textContent);
      if(!newText)return;
      div.querySelector('.text').textContent=newText;
      updateHistory(id,newText);
      broadcast({type:'edit',id,newText});
    }
    function deleteMsg(div,id){
      div.remove();
      chatHistory=chatHistory.filter(m=>m.id!==id);
      broadcast({type:'delete',id});
    }
    function updateHistory(id,newText){ const msg=chatHistory.find(m=>m.id===id); if(msg) msg.text=newText; }

    function addSystem(text){
      const div=document.createElement('div');
      div.className='system';
      div.textContent=text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }

    function updateUserList(){
      userListEl.innerHTML="";
      Object.values(users).forEach(u=>{
        const div=document.createElement('div');
        div.className='user';
        div.style.color=u.color;
        div.textContent=`${u.nick} â€¢ ${u.status}`;
        userListEl.appendChild(div);
      });
    }

    let typingTimeout;
    function showTyping(user){
      typingEl.textContent=`${user} is typing...`;
      clearTimeout(typingTimeout);
      typingTimeout=setTimeout(()=>{typingEl.textContent="";},2000);
    }

    function timestamp(){const d=new Date();return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
    function escapeHtml(s){ return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

    function applyTheme(t){
      if(t==='light'){
        document.documentElement.style.setProperty('--bg','#f3f3f3');
        document.documentElement.style.setProperty('--panel','#ffffff');
        document.documentElement.style.setProperty('--text','#1e1e1e');
        document.documentElement.style.setProperty('--muted','#555');
      } else if(t==='amoled'){
        document.documentElement.style.setProperty('--bg','#000000');
        document.documentElement.style.setProperty('--panel','#111111');
        document.documentElement.style.setProperty('--text','#ffffff');
        document.documentElement.style.setProperty('--muted','#888');
      } else {
        document.documentElement.style.setProperty('--bg','#36393f');
        document.documentElement.style.setProperty('--panel','#2f3136');
        document.documentElement.style.setProperty('--text','#dcddde');
        document.documentElement.style.setProperty('--muted','#72767d');
      }
    }

    function applyMsgStyle(style){
      if(style==='compact'){
        document.documentElement.style.setProperty('--msg-spacing','4px');
        document.documentElement.style.setProperty('--msg-font-size','13px');
      } else {
        document.documentElement.style.setProperty('--msg-spacing','12px');
        document.documentElement.style.setProperty('--msg-font-size','14px');
      }
    }
  </script>
</body>
</html>

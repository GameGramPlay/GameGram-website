<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hack.Chat Client</title>
  <script src="https://cdn.jsdelivr.net/gh/hack-chat/engine@0.0.5/dist/hackchat-engine.min.js"></script>
  <style>
    body { font-family:sans-serif; background:#222; color:#eee; padding:20px; }
    #chat { border:1px solid #555; height:300px; overflow:auto; padding:5px; margin:10px 0; }
    .message { margin:2px 0; }
    .nick { font-weight:bold; margin-right:5px; }
    .system-message { font-style:italic; color:#ff0; margin:2px 0; }
    input, button { margin:2px 0; }
  </style>
</head>
<body>
  <h1>Hack.Chat Client</h1>
  <input id="nickname" placeholder="Enter your nickname" />
  <input id="room" placeholder="Enter room name" />
  <button id="join">Join</button>

  <div id="chat"></div>

  <input id="message" placeholder="Type a message..." />
  <button id="send">Send</button>

  <script>
    let client;
    let nickname = '';
    let room = 'public';

    // ================= UI =================
    const UI = {
      chatDiv: document.getElementById('chat'),
      addMessage(nick, text) {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<span class="nick">${nick}:</span> <span>${text}</span>`;
        this.chatDiv.appendChild(div);
        this.chatDiv.scrollTop = this.chatDiv.scrollHeight;
      },
      addSystem(text) {
        const div = document.createElement('div');
        div.className = 'system-message';
        div.textContent = text;
        this.chatDiv.appendChild(div);
        this.chatDiv.scrollTop = this.chatDiv.scrollHeight;
      }
    };

    // ================= LOGIN =================
    document.getElementById('join').addEventListener('click', () => {
      nickname = document.getElementById('nickname').value.trim() || 'Guest';
      room = document.getElementById('room').value.trim() || 'public';

      UI.addSystem(`Connecting as "${nickname}" to room "${room}"...`);

      client = new Client({ ws: { gateway: 'wss://hack.chat/chat-ws' } });

      client.on('session', () => {
        client.join(nickname, '', room);
      });

      client.on('channelJoined', () => {
        UI.addSystem(`Joined room "${room}" successfully!`);
      });

      client.on('message', payload => {
        const nick = payload.nick || 'anon';
        const text = payload.text || '';
        UI.addMessage(nick, text);
      });

      client.on('onlineAdd', payload => {
        UI.addSystem(`${payload.nick} joined the room.`);
      });

      client.on('onlineRemove', payload => {
        UI.addSystem(`${payload.nick} left the room.`);
      });

      client.on('disconnect', () => {
        UI.addSystem('Disconnected from server. Reconnecting...');
        setTimeout(() => document.getElementById('join').click(), 3000);
      });
    });

    // ================= SEND MESSAGE =================
    document.getElementById('send').addEventListener('click', () => {
      const text = document.getElementById('message').value.trim();
      if (!text || !client) return;
      client.say(text);
      UI.addMessage(nickname, text);
      document.getElementById('message').value = '';
    });

    document.getElementById('message').addEventListener('keypress', e => {
      if (e.key === 'Enter') document.getElementById('send').click();
    });
  </script>
</body>
</html>
